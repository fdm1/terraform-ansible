#! /bin/bash
set -e -o pipefail
PROJECT_ROOT=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../
source ${PROJECT_ROOT}/bin/_shared.sh

usage() {
  cat <<EOF
bin/ssh <cloud_provider [do|digitalocean, aws|lightsail] (default=do)> <username (default=frankmassi)>
EOF
}

CLOUD=do
USERNAME=frankmassi

if [[ $# == 1 ]]; then
  CLOUD=$1
fi

if [[ $# == 2 ]]; then
  CLOUD=$1
  USERNAME=$2
fi

if [[ $# > 2 ]]; then
  usage
  exit 1
fi

set -u

refresh_terraform

KEY=$(terraform output -json | jq --raw-output .fdm1_lightsail_rsa_key.value)
set_remote_hosts
set_instance_type $CLOUD

HOST_VAR=${INSTANCE_TYPE}_HOST
HOST_IP=$(eval echo \$${HOST_VAR})

ssh -A -i $KEY -o StrictHostKeyChecking=no $USERNAME@$HOST_IP
